<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gift Ideas Form</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;600&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.16.0/dist/umd/supabase.min.js"></script>
  <link rel="stylesheet" href="main.css">
  <link rel="icon" href="favicon.ico" type="image/x-icon">

</head>
<body>

<div class="name-container" style="margin-bottom: 120px; z-index: 100;">
  <h1 id="petros-header" style="cursor: pointer;">Petros</h1>
  <h1 id="mikis-header" style="cursor: pointer;">Mikis</h1>
  <h1 id="anna-header" style="cursor: pointer;">Anna</h1>
  <h1 id="katarina-header" style="cursor: pointer;">Katarina</h1>
  <h1 id="manolis-header" style="cursor: pointer;">Manolis</h1>
  <h1 id="iannis-header" style="cursor: pointer;">Iannis</h1>
  <h1 id="alexandra-header" style="cursor: pointer;">Alexandra</h1>
</div>

<div id="petros" style="display: none;">
  <div class="popup-header">Gift Ideas</div>
  <label for="1-1">Gift Idea 1:</label>
  <input type="text" id="1-1" />
  <br>
  <label for="1-2">Gift Idea 2:</label>
  <input type="text" id="1-2" />
  <br>
  <label for="1-3">Gift Idea 3:</label>
  <input type="text" id="1-3" />
  <br>
  <label for="1-4">Gift Idea 4:</label>
  <input type="text" id="1-4" />
  <br>
  <label for="1-5">Gift Idea 5:</label>
  <input type="text" id="1-5" />
</div>

<div id="mikis" style="display: none;">
  <div class="popup-header">Gift Ideas</div>
  <label for="2-1">Gift Idea 1:</label>
  <input type="text" id="2-1" />
  <br>
  <label for="2-2">Gift Idea 2:</label>
  <input type="text" id="2-2" />
  <br>
  <label for="2-3">Gift Idea 3:</label>
  <input type="text" id="2-3" />
  <br>
  <label for="2-4">Gift Idea 4:</label>
  <input type="text" id="2-4" />
  <br>
  <label for="2-5">Gift Idea 5:</label>
  <input type="text" id="2-5" />
</div>

<div id="anna" style="display: none;">
  <div class="popup-header">Gift Ideas</div>
  <label for="1-1">Gift Idea 1:</label>
  <input type="text" id="3-1" />
  <br>
  <label for="1-2">Gift Idea 2:</label>
  <input type="text" id="3-2" />
  <br>
  <label for="1-3">Gift Idea 3:</label>
  <input type="text" id="3-3" />
  <br>
  <label for="1-4">Gift Idea 4:</label>
  <input type="text" id="3-4" />
  <br>
  <label for="1-5">Gift Idea 5:</label>
  <input type="text" id="3-5" />
</div>

<div id="katarina" style="display: none;">
  <div class="popup-header">Gift Ideas</div>
  <label for="2-1">Gift Idea 1:</label>
  <input type="text" id="4-1" />
  <br>
  <label for="2-2">Gift Idea 2:</label>
  <input type="text" id="4-2" />
  <br>
  <label for="2-3">Gift Idea 3:</label>
  <input type="text" id="4-3" />
  <br>
  <label for="2-4">Gift Idea 4:</label>
  <input type="text" id="4-4" />
  <br>
  <label for="2-5">Gift Idea 5:</label>
  <input type="text" id="4-5" />
</div>

<div id="manolis" style="display: none;">
  <div class="popup-header">Gift Ideas</div>
  <label for="1-1">Gift Idea 1:</label>
  <input type="text" id="5-1" />
  <br>
  <label for="1-2">Gift Idea 2:</label>
  <input type="text" id="5-2" />
  <br>
  <label for="1-3">Gift Idea 3:</label>
  <input type="text" id="5-3" />
  <br>
  <label for="1-4">Gift Idea 4:</label>
  <input type="text" id="5-4" />
  <br>
  <label for="1-5">Gift Idea 5:</label>
  <input type="text" id="5-5" />
</div>

<div id="iannis" style="display: none;">
  <div class="popup-header">Gift Ideas</div>
  <label for="2-1">Gift Idea 1:</label>
  <input type="text" id="6-1" />
  <br>
  <label for="2-2">Gift Idea 2:</label>
  <input type="text" id="6-2" />
  <br>
  <label for="2-3">Gift Idea 3:</label>
  <input type="text" id="6-3" />
  <br>
  <label for="2-4">Gift Idea 4:</label>
  <input type="text" id="6-4" />
  <br>
  <label for="2-5">Gift Idea 5:</label>
  <input type="text" id="6-5" />
</div>

<div id="alexandra" style="display: none;">
  <div class="popup-header">Gift Ideas</div>
  <label for="2-1">Gift Idea 1:</label>
  <input type="text" id="7-1" />
  <br>
  <label for="2-2">Gift Idea 2:</label>
  <input type="text" id="7-2" />
  <br>
  <label for="2-3">Gift Idea 3:</label>
  <input type="text" id="7-3" />
  <br>
  <label for="2-4">Gift Idea 4:</label>
  <input type="text" id="7-4" />
  <br>
  <label for="2-5">Gift Idea 5:</label>
  <input type="text" id="7-5" />
</div>

<section class="mountains">
	<div class='mt1'>
		<div class="mtsnow1"></div>
		<div class="snow-peak-1a"></div>
		<div class="snow-peak-1b"></div>
	</div>
	<div class="mt2">
		<div class="snow2"></div>
		<div class="snow-peak-2a"></div>
		<div class="snow-peak-2b"></div>
		<div class="snow-peak-2c"></div>
	</div>
	<div class="mt3">
		<div class="snow3"></div>
		<div class="snow-peak-3a"></div>
		<div class="snow-peak-3b"></div>
		<div class="snow-peak-3c"></div>
		<div class="snow-peak-3d"></div>
	</div>
	<div class='mt4'>
		<div class="snow4"></div>
		<div class="snow-peak-4a"></div>
		<div class="snow-peak-4b"></div>
	</div>
	<div class="mt5">
		<div class="snow5"></div>
		<div class="snow-peak-5a"></div>
		<div class="snow-peak-5b"></div>
		<div class="snow-peak-5c"></div>
	</div>
	<div class="mt6">
		<div class="snow6"></div>
		<div class="snow-peak-6a"></div>
		<div class="snow-peak-6b"></div>
		<div class="snow-peak-6c"></div>
		<div class="snow-peak-6d"></div>
	</div>
</section>

<script>
window.supabaseUrl = 'https://bxolcjhxlttrdbdipopa.supabase.co';
window.supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4b2xjamh4bHR0cmRiZGlwb3BhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mjk0MzczNjgsImV4cCI6MjA0NTAxMzM2OH0.CpEyTjh0Td7Sts9t5LY8FUNR9cgiH0wPp5iTzNwIbGc';
window.supabase = supabase.createClient(window.supabaseUrl, window.supabaseKey);

  let typingUsers = new Set();

  async function updateGiftIdea(id, gift_idea) {
    try {
      if (gift_idea === "") {
        const { data, error } = await window.supabase
          .from('gift_ideas')
          .delete()
          .match({ id });

        if (error) {
          console.error('Error deleting gift idea:', error);
        } else {
          console.log('Gift idea deleted successfully');
        }
      } else {
        const { data, error } = await window.supabase
          .from('gift_ideas')
          .upsert([{ id, gift_idea }], { onConflict: ['id'] });

        if (error) {
          console.error('Error updating/adding gift idea:', error);
        } else {
          console.log('Gift idea updated/added successfully');
        }
      }
    } catch (error) {
      console.error('Unexpected error:', error);
    }
  }

  async function fetchGiftIdeas() {
    try {
      const { data, error } = await window.supabase
        .from('gift_ideas')
        .select('*');

      if (error) {
        console.error('Error fetching gift ideas:', error);
      } else {
        data.forEach(row => {
          const input = document.getElementById(row.id);
          if (input) {
            input.value = row.gift_idea;
          }
        });
      }
    } catch (error) {
      console.error('Unexpected error:', error);
    }
  }

  window.supabase
    .channel('gift_ideas_channel')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'gift_ideas' }, payload => {
      const id = payload.new.id;
      if (!typingUsers.has(id)) {
        const gift_idea = payload.new.gift_idea;
        document.getElementById(id).value = gift_idea;
      }
    })
    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'gift_ideas' }, payload => {
      const id = payload.new.id;
      if (!typingUsers.has(id)) {
        const gift_idea = payload.new.gift_idea;
        document.getElementById(id).value = gift_idea;
      }
    })
    .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'gift_ideas' }, payload => {
      const id = payload.old.id;
      const input = document.getElementById(id);
      if (input) {
        input.value = '';
      }
    })
    .subscribe();

  document.querySelectorAll('input[type="text"]').forEach(input => {
    input.addEventListener('input', (event) => {
      const id = event.target.id;
      const gift_idea = event.target.value;

      typingUsers.add(id);

      updateGiftIdea(id, gift_idea);
    });

    input.addEventListener('blur', () => {
      typingUsers.delete(input.id);
      updateGiftIdea(input.id, input.value);
    });

    let typingTimer;
    input.addEventListener('input', () => {
      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => {
        typingUsers.delete(input.id);
      }, 500);
    });
  });

	window.onload = async () => {
	  await fetchGiftIdeas();

	  setInterval(() => {
		location.reload();
	  }, 60000);
	};

  // Your earlier code

  window.addEventListener('DOMContentLoaded', (event) => {
    const isLoggedIn = localStorage.getItem('isLoggedIn');
    const username = localStorage.getItem('username');

    if (!isLoggedIn || !username) {
      window.location.href = 'login.html';
    } else {
      const allUsers = ['petros', 'iannis', 'mikis', 'anna', 'katarina', 'manolis', 'alexandra'];

      allUsers.forEach(user => {
        const userDiv = document.getElementById(user);
        if (userDiv) {
          userDiv.style.display = 'none';
        }
      });

      const userDiv = document.getElementById(username.toLowerCase());
      if (userDiv) {
        userDiv.style.display = 'none';
      }

      const allHeaders = document.querySelectorAll('h1');
      allHeaders.forEach(header => {
        const headerId = header.id.replace('-header', '');
        const userDiv = document.getElementById(headerId);

        if (userDiv && headerId !== username.toLowerCase()) {
          header.addEventListener('click', (event) => {
            const mouseX = event.clientX;
            const mouseY = event.clientY;

            const sectionDiv = document.getElementById(headerId);

            if (sectionDiv) {
              sectionDiv.style.display = 'block';

              sectionDiv.style.left = `${mouseX}px`;
              sectionDiv.style.top = `${mouseY}px`;
            }
          });

          const labels = document.querySelectorAll(`#${headerId} label`);
          labels.forEach((label, index) => {
            label.innerHTML = `${index + 1}`;
          });

          const giftIdeasContainer = document.getElementById(headerId);
          const rows = giftIdeasContainer.querySelectorAll('label');
          rows.forEach((row, index) => {
            const giftRow = document.createElement('div');
            giftRow.classList.add('gift-row');

            const numberCircle = document.createElement('div');
            numberCircle.classList.add('gift-number');
            numberCircle.textContent = `${index + 1}`;

            const inputField = row.nextElementSibling;

            giftRow.appendChild(numberCircle);
            giftRow.appendChild(inputField);

            row.parentNode.replaceChild(giftRow, row);
          });

          document.addEventListener('click', (event) => {
            if (!userDiv.contains(event.target) && !header.contains(event.target)) {
              userDiv.style.display = 'none';
            }
          });
        }
      });
    }
  });

  // Assuming you want to show a popup, wrap the code inside a function
  function showPopup(popupId) {
    const popup = document.getElementById(popupId);
    if (popup) {
      popup.style.display = 'block';

      // Ensures CSS transition kicks in after visibility change
      popup.offsetHeight; // Trigger reflow
      popup.classList.add('opening');
    }
  }

</script>
</body>
</html>